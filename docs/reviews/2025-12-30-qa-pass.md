# QA Review: feat/hsm-dual-mode-with-viz-and-examples

**Date:** 2025-12-30
**Branch:** feat/hsm-dual-mode-with-viz-and-examples
**Preview URL:** https://deploy-preview-31--matchina-docs.netlify.app/

---

## Executive Summary

Branch builds and preview runs. Ready for merge after addressing critical picker consolidation issue. HSM examples work well. Multiple visualization systems exist that need consolidation.

---

## üî¥ P0: CRITICAL - Visualizer Picker Chaos

### The Core Problem

There are **3 different visualizer picker systems** in use, causing:
- Inconsistent UX across examples
- Duplicate options (Force Graph appears twice in some pickers)
- Broken "Basic" option that never works
- Examples breaking when switching visualizers

### Picker Inventory

| Component | Location | UI Style | Options | Used By |
|-----------|----------|----------|---------|---------|
| `VizPicker` + `MachineVisualizer` | `VizPicker.tsx`, `MachineVisualizer.tsx` | Dropdown | 5: reactflow, sketch, forcegraph, mermaid-statechart, mermaid-flowchart | **1 example** (toggle) |
| `MachineExampleWithChart` | `MachineExampleWithChart.tsx` | Dropdown + nested controls | 4: force-graph, react-flow, mermaid, basic | **17 examples** |
| `VisualizerDemo` (HSMVisualizerDemo) | `HSMVisualizerDemo.tsx` | Button toggles | 5 (with duplicate): sketch, mermaid, reactflow, forcegraph, **forcegraph** | **6 examples** |

### Examples by Picker Type

**‚úÖ Using `MachineVisualizer` (correct, unified):**
- `toggle/example.tsx`

**‚ö†Ô∏è Using `MachineExampleWithChart` (old, has broken "Basic"):**
- `stopwatch-using-react-state-and-effects/index.tsx`
- `stopwatch-using-data-and-hooks/example.tsx`
- `promise-machine-fetcher/example.tsx`
- `traffic-light-extended/example.tsx`
- `checkout/example.tsx`
- `stopwatch-using-data-and-transition-functions/example.tsx`
- `stopwatch-using-external-react-state-and-state-effects/example.tsx`
- `stopwatch-using-react-state-and-state-effects/example.tsx`
- `stopwatch-using-react-state-using-lifecycle-instead-of-useEffect/example.tsx`
- `counter/example.tsx`
- `traffic-light/example.tsx`
- `async-calculator/example.tsx`
- `fetcher-advanced/example.tsx`
- `balanced-paren-checker/index.tsx`
- `stopwatch/example.tsx`
- `auth-flow/example.tsx`
- `stopwatch-using-react-state-using-transitionhooks/example.tsx`

**‚ùå Using `VisualizerDemo` (duplicate Force Graph, breaks examples):**
- `rock-paper-scissors/example.tsx`
- `hsm-checkout/example.tsx`
- `hsm-checkout/index.tsx`
- `hsm-traffic-light/example.tsx`
- `hsm-combobox/example.tsx`
- `hsm-combobox/index.tsx`

### Critical Bug in HSMVisualizerDemo

```typescript
// HSMVisualizerDemo.tsx lines 75-101
const visualizers = useMemo(() => [
  { key: 'sketch', label: 'Sketch Systems Style', ... },
  { key: 'mermaid', label: 'Mermaid Diagram', ... },
  { key: 'reactflow', label: 'React Flow', ... },
  { key: 'forcegraph', label: 'Force Graph', ... },
  { key: 'forcegraph', label: 'Force Graph', ... }  // ‚Üê DUPLICATE!
], []);
```

### Recommended Action

1. **Immediate:** Remove duplicate Force Graph from HSMVisualizerDemo
2. **Immediate:** Remove "Basic" option from MachineExampleWithChart
3. **Short-term:** Migrate all examples to use `MachineVisualizer`
4. **Deprecate:** Mark `MachineExampleWithChart` and `VisualizerDemo` as deprecated

---

## üü† P1: HIGH - Functional Issues

### 1. Traffic Light Example Broken
- **Location:** Basic traffic light (`/examples/traffic-light/`)
- **Issue:** Signal button doesn't work; clicking edges doesn't transition
- **Suspect:** May be related to picker issues

### 2. Rock Paper Scissors Game Breaks on Visualizer Switch
- **Location:** `/examples/rock-paper-scissors/`
- **Issue:** Game works on React Flow, but switching to Sketch locks up after one move
- **Note:** Uses functional transitions (known foot gun)

### 3. Flattened HSM Combo Box Not Suggesting
- **Location:** `/hierarchical/combobox/` (flattened mode)
- **Issue:** Typing doesn't trigger suggestions; stuck in text entry state
- **Note:** Nested version works correctly

### 4. React Flow Layout Button Non-Functional
- **Location:** All React Flow visualizers
- **Issue:** Layout/arrange button doesn't respond
- **Status:** Existing ticket may exist

### 5. Async Calculator Diagram Incomplete
- **Location:** `/examples/async-calculator/`
- **Issue:** Should show 3 states, only shows 2

---

## üü° P2: MEDIUM - Styling Issues

### 1. React Flow Previous State Styling
- **Location:** All React Flow diagrams (e.g., Quick Start traffic light)
- **Issue:** Previous state has transparent background, looks weird on dotted grid
- **Fix:** Use solid background (muted gray or theme-aware)

### 2. Mermaid Label Hover Styling (Dark Mode)
- **Issue:** Gray background ‚Üí rich purple with black text (hard to read)
- **Fix:** Ensure sufficient contrast on hover

### 3. Mermaid Label Clipping
- **Issue:** Bold text in labels overflows background rectangle
- **Cause:** Container sized for regular weight, bold expands text

### 4. Mermaid Statechart Overflow (HSM Traffic Light)
- **Location:** `/hierarchical/traffic-light/`
- **Issue:** Statechart diagram overflows container
- **Note:** Flowchart zooms correctly, statechart does not

### 5. Mermaid Flowchart Yellow Boxes
- **Location:** HSM examples with hierarchy
- **Issue:** Yellow box styling for hierarchical groups returned
- **Note:** Was fixed before, has regressed

### 6. Counter Example Layout
- **Location:** `/examples/counter/`
- **Issue:** Single-state machine with 3 self-transitions looks awkward in React Flow

### 7. HSM Checkout Wizard Tabs
- **Location:** `/hierarchical/checkout/`
- **Issue:** Horizontal tab list too wide, causes scrolling
- **Suggestion:** Compress or use checkmarks instead of numbers

---

## üü¢ P3: LOW - Enhancements

### 1. React Flow Hierarchical Grouping
- **Issue:** No visual grouping for nested states in React Flow
- **Note:** States appear but aren't grouped or connected properly

### 2. Visualizer Documentation
- **Status:** Visualizers externalized but undocumented
- **Suggestion:** Add docs page, mark as experimental

### 3. DevTools Support
- **Scope:** Store machines and state machines
- **Feature:** Time-travel logging/debugging

### 4. Consistent Color Scheme
- **Issue:** React Flow imposes its own blue colors
- **Goal:** Unified color scheme across all visualizers

### 5. Extract React Viz to Separate Library
- **Note:** Dependency management TBD

---

## üîµ P4: BACKLOG - Minor Issues

### 1. Broken Link
- **Location:** HSM documentation
- **Issue:** Link to "HSM traffic light flat" uses old slug (dropped "flat")

### 2. HSM Checkout Exit Payment Button
- **Location:** `/hierarchical/checkout/`
- **Issue:** "Exit Payment" doesn't work, but "Back to Shipping" does

### 3. Functional Transitions Documentation
- **Note:** Rock Paper Scissors uses functional transitions heavily
- **Suggestion:** Document as escape hatch / foot gun in guidance

---

## What Works Well ‚úÖ

1. **Build completes successfully**
2. **Preview deploys correctly**
3. **Sketch visualizer** - Most reliable across all examples
4. **Force Graph** - Generally works when picker doesn't break it
5. **Nested HSM examples** - Better than flattened versions
6. **HSM traffic light (nested)** - Good reference implementation
7. **Toggle example** - Uses new unified `MachineVisualizer` correctly

---

## Files Changed in This Review

### Visualizer Components
- `docs/src/components/VizPicker.tsx` - New unified picker (5 options, no duplicates)
- `docs/src/components/MachineVisualizer.tsx` - New unified wrapper
- `docs/src/components/MachineExampleWithChart.tsx` - Old wrapper (has "Basic")
- `docs/src/components/HSMVisualizerDemo.tsx` - Old HSM wrapper (duplicate Force Graph)
- `docs/src/components/DemoWithMermaid.tsx` - Wrapper that uses MachineExampleWithChart
- `docs/src/components/vizAutoSelect.ts` - Auto-selection logic
- `docs/src/components/index.ts` - Exports

### Related Documentation
- `docs/UNIFIED_VISUALIZER.md` - Documents the consolidation plan
- `docs/VIZ_UX_DESIGN.md` - Original design document

---

## Recommended Merge Strategy

### Before Merge (Quick Fixes)
1. Remove duplicate Force Graph from `HSMVisualizerDemo.tsx` (line 96-100)
2. Remove "Basic" option from `MachineExampleWithChart.tsx`

### After Merge (Follow-up PR)
1. Migrate all examples to `MachineVisualizer`
2. Deprecate old components
3. Fix React Flow styling issues
4. Address mermaid overflow issues

---

## Test Checklist

- [x] Build completes (`npm run build`)
- [x] Preview deploys
- [ ] All examples render without console errors
- [ ] Visualizer switching doesn't break example state
- [ ] Dark mode styling consistent
- [ ] React Flow layout button works
- [ ] Mermaid diagrams contained within bounds
