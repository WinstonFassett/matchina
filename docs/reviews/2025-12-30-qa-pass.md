# QA Review: feat/hsm-dual-mode-with-viz-and-examples

**Date:** 2025-12-30
**Branch:** feat/hsm-dual-mode-with-viz-and-examples
**Preview URL:** https://deploy-preview-31--matchina-docs.netlify.app/

---

## Executive Summary

Branch builds and preview runs. Ready for merge after addressing critical picker consolidation issue. HSM examples work well. Multiple visualization systems exist that need consolidation.

---

## üî¥ P0: CRITICAL - Visualizer Picker Chaos

### The Core Problem

There are **3 different visualizer picker systems** in use, causing:
- Inconsistent UX across examples
- Duplicate options (Force Graph appears twice in some pickers)
- Broken "Basic" option that never works
- Examples breaking when switching visualizers

### Picker Inventory

| Component | Location | UI Style | Options | Used By |
|-----------|----------|----------|---------|---------|
| `MachineVisualizer` | `MachineVisualizer.tsx` (uses `VizPicker.tsx`) | Dropdown | 5: reactflow, sketch, forcegraph, mermaid-statechart, mermaid-flowchart | **1 example** (toggle) |
| `MachineExampleWithChart` | `MachineExampleWithChart.tsx` | Dropdown + nested controls | 4: force-graph, react-flow, mermaid, basic | **17 examples** |
| `VisualizerDemo` | `HSMVisualizerDemo.tsx` | Button toggles | 5 (with duplicate): sketch, mermaid, reactflow, forcegraph, **forcegraph** | **6 examples** |

### Examples by Picker Type

**‚úÖ Using `MachineVisualizer` (correct, unified):**
- `toggle/example.tsx`

**‚ö†Ô∏è Using `MachineExampleWithChart` (old, has broken "Basic"):**
- `stopwatch-using-react-state-and-effects/index.tsx`
- `stopwatch-using-data-and-hooks/example.tsx`
- `promise-machine-fetcher/example.tsx`
- `traffic-light-extended/example.tsx`
- `checkout/example.tsx`
- `stopwatch-using-data-and-transition-functions/example.tsx`
- `stopwatch-using-external-react-state-and-state-effects/example.tsx`
- `stopwatch-using-react-state-and-state-effects/example.tsx`
- `stopwatch-using-react-state-using-lifecycle-instead-of-useEffect/example.tsx`
- `counter/example.tsx`
- `traffic-light/example.tsx`
- `async-calculator/example.tsx`
- `fetcher-advanced/example.tsx`
- `balanced-paren-checker/index.tsx`
- `stopwatch/example.tsx`
- `auth-flow/example.tsx`
- `stopwatch-using-react-state-using-transitionhooks/example.tsx`

**‚ùå Using `VisualizerDemo` (duplicate Force Graph, breaks examples):**
- `rock-paper-scissors/example.tsx`
- `hsm-checkout/example.tsx`
- `hsm-checkout/index.tsx`
- `hsm-traffic-light/example.tsx`
- `hsm-combobox/example.tsx`
- `hsm-combobox/index.tsx`

### Critical Bug in HSMVisualizerDemo

```typescript
// HSMVisualizerDemo.tsx lines 75-101
const visualizers = useMemo(() => [
  { key: 'sketch', label: 'Sketch Systems Style', ... },
  { key: 'mermaid', label: 'Mermaid Diagram', ... },
  { key: 'reactflow', label: 'React Flow', ... },
  { key: 'forcegraph', label: 'Force Graph', ... },
  { key: 'forcegraph', label: 'Force Graph', ... }  // ‚Üê DUPLICATE!
], []);
```

### Recommended Action

1. **Immediate:** Remove duplicate Force Graph from HSMVisualizerDemo
2. **Immediate:** Remove "Basic" option from MachineExampleWithChart
3. **Short-term:** Migrate all examples to use `MachineVisualizer`
4. **Deprecate:** Mark `MachineExampleWithChart` and `VisualizerDemo` as deprecated

---

## üü† P1: HIGH - Functional Issues

### 1. Traffic Light Example Broken
- **Location:** Basic traffic light (`/examples/traffic-light/`)
- **Issue:** Signal button doesn't work; clicking edges doesn't transition
- **Suspect:** May be related to picker issues

### 2. Rock Paper Scissors Game Breaks on Visualizer Switch
- **Location:** `/examples/rock-paper-scissors/`
- **Issue:** Game works on React Flow, but switching to Sketch locks up after one move
- **Note:** Uses functional transitions (known foot gun)

### 3. Flattened HSM Combo Box Not Suggesting
- **Location:** `/hierarchical/combobox/` (flattened mode)
- **Issue:** Typing doesn't trigger suggestions; stuck in text entry state
- **Note:** Nested version works correctly

### 4. React Flow Layout Button Non-Functional
- **Location:** All React Flow visualizers
- **Issue:** Layout/arrange button doesn't respond
- **Status:** Existing ticket may exist

### 5. Async Calculator Diagram Incomplete
- **Location:** `/examples/async-calculator/`
- **Issue:** Should show 3 states, only shows 2

---

## üü° P2: MEDIUM - Styling Issues

### 1. React Flow Previous State Styling
- **Location:** All React Flow diagrams (e.g., Quick Start traffic light)
- **Issue:** Previous state has transparent background, looks weird on dotted grid
- **Fix:** Use solid background (muted gray or theme-aware)

### 2. Mermaid Label Hover Styling (Dark Mode)
- **Issue:** Gray background ‚Üí rich purple with black text (hard to read)
- **Fix:** Ensure sufficient contrast on hover

### 3. Mermaid Label Clipping
- **Issue:** Bold text in labels overflows background rectangle
- **Cause:** Container sized for regular weight, bold expands text

### 4. Mermaid Statechart Overflow (HSM Traffic Light)
- **Location:** `/hierarchical/traffic-light/`
- **Issue:** Statechart diagram overflows container
- **Note:** Flowchart zooms correctly, statechart does not

### 5. Mermaid Flowchart Yellow Boxes
- **Location:** HSM examples with hierarchy
- **Issue:** Yellow box styling for hierarchical groups returned
- **Note:** Was fixed before, has regressed

### 6. Counter Example Layout
- **Location:** `/examples/counter/`
- **Issue:** Single-state machine with 3 self-transitions looks awkward in React Flow

### 7. HSM Checkout Wizard Tabs
- **Location:** `/hierarchical/checkout/`
- **Issue:** Horizontal tab list too wide, causes scrolling
- **Suggestion:** Compress or use checkmarks instead of numbers

---

## üü¢ P3: LOW - Enhancements

### 1. React Flow Hierarchical Grouping
- **Issue:** No visual grouping for nested states in React Flow
- **Note:** States appear but aren't grouped or connected properly

### 2. Visualizer Documentation
- **Status:** Visualizers externalized but undocumented
- **Suggestion:** Add docs page, mark as experimental

### 3. DevTools Support
- **Scope:** Store machines and state machines
- **Feature:** Time-travel logging/debugging

### 4. Consistent Color Scheme
- **Issue:** React Flow imposes its own blue colors
- **Goal:** Unified color scheme across all visualizers

### 5. Extract React Viz to Separate Library
- **Note:** Dependency management TBD

---

## üîµ P4: BACKLOG - Minor Issues

### 1. Broken Link
- **Location:** HSM documentation
- **Issue:** Link to "HSM traffic light flat" uses old slug (dropped "flat")

### 2. HSM Checkout Exit Payment Button
- **Location:** `/hierarchical/checkout/`
- **Issue:** "Exit Payment" doesn't work, but "Back to Shipping" does

### 3. Functional Transitions Documentation
- **Note:** Rock Paper Scissors uses functional transitions heavily
- **Suggestion:** Document as escape hatch / foot gun in guidance

---

## What Works Well ‚úÖ

1. **Build completes successfully**
2. **Preview deploys correctly**
3. **Sketch visualizer** - Most reliable across all examples
4. **Force Graph** - Generally works when picker doesn't break it
5. **Nested HSM examples** - Better than flattened versions
6. **HSM traffic light (nested)** - Good reference implementation
7. **Toggle example** - Uses new unified `MachineVisualizer` correctly

---

## Files Changed in This Review

### Visualizer Components
- `docs/src/components/VizPicker.tsx` - New unified picker (5 options, no duplicates)
- `docs/src/components/MachineVisualizer.tsx` - New unified wrapper
- `docs/src/components/MachineExampleWithChart.tsx` - Old wrapper (has "Basic")
- `docs/src/components/HSMVisualizerDemo.tsx` - Old HSM wrapper (duplicate Force Graph)
- `docs/src/components/DemoWithMermaid.tsx` - Wrapper that uses MachineExampleWithChart
- `docs/src/components/vizAutoSelect.ts` - Auto-selection logic
- `docs/src/components/index.ts` - Exports

### Related Documentation
- `docs/UNIFIED_VISUALIZER.md` - Documents the consolidation plan
- `docs/VIZ_UX_DESIGN.md` - Original design document

---

## Workstreams

### WS1: Picker Consolidation (BLOCKING)
Root cause of most issues. Do this first.

| Task | Scope | Blocking? |
|------|-------|-----------|
| Remove duplicate Force Graph from `HSMVisualizerDemo.tsx:92-100` | 1 file | **Yes - before merge** |
| Remove "Basic" option from `MachineExampleWithChart.tsx` | 1 file | **Yes - before merge** |
| Standardize keys: `force-graph` ‚Üí `forcegraph` | 2 files | No |
| Standardize labels: `Force Graph` ‚Üí `ForceGraph`, `State Chart` ‚Üí `Statechart` | 3 files | No |
| Migrate 17 examples from `MachineExampleWithChart` ‚Üí `MachineVisualizer` | 17 files | No |
| Migrate 6 examples from `VisualizerDemo` ‚Üí `MachineVisualizer` | 6 files | No |
| Delete `MachineExampleWithChart.tsx`, `HSMVisualizerDemo.tsx`, `DemoWithMermaid.tsx` | 3 files | No |

### WS2: ReactFlow Fixes
| Task | Priority |
|------|----------|
| Previous state: solid background instead of transparent | P2 |
| Layout button not responding | P1 |
| Hierarchical grouping for nested states | P3 |

### WS3: Mermaid Fixes
| Task | Priority |
|------|----------|
| Statechart overflow in HSM examples | P2 |
| Yellow box regression for hierarchy groups | P2 |
| Label hover contrast (dark mode) | P2 |
| Bold label clipping | P2 |

### WS4: Example-Specific Bugs
| Example | Issue | Priority |
|---------|-------|----------|
| Traffic Light | Signal button broken, edge clicks don't transition | P1 |
| Rock Paper Scissors | Locks up on Sketch after one move | P1 |
| HSM Combo Box (flat) | Not suggesting on keypress | P1 |
| Async Calculator | Shows 2 states, should be 3 | P1 |
| HSM Checkout | Exit Payment button broken | P4 |

### WS5: Polish (Defer)
- Visualizer documentation page
- DevTools / time-travel debugging
- Unified color scheme across visualizers
- Extract React viz to separate package
- Counter single-state layout
- HSM Checkout wizard tab width

---

## Merge Decision

**Minimum for merge:**
1. ‚úÖ Build passes
2. ‚úÖ Preview deploys
3. ‚úÖ ~~Remove duplicate Force Graph (WS1)~~ ‚Üí Full migration completed
4. ‚úÖ ~~Remove "Basic" option (WS1)~~ ‚Üí Full migration completed

**WS1 COMPLETED:** All 23 examples migrated to `MachineVisualizer`. Old components deleted.

**Remaining workstreams (WS2-WS5) can be follow-up PRs.**

---

## Test Checklist

- [x] Build completes (`npm run build`)
- [x] Preview deploys
- [ ] All examples render without console errors
- [x] ~~Visualizer switching doesn't break example state~~ **FAILS - see P0 bug below**
- [ ] Dark mode styling consistent
- [ ] React Flow layout button works
- [ ] Mermaid diagrams contained within bounds

---

## Post-WS1 QA Pass (2025-12-30)

### ‚úÖ Toggle - WORKS
- All visualizers work correctly
- Interactive, stays alive on switch
- Good baseline reference

### ‚ùå Counter - BROKEN
- Defaults to ReactFlow, **no height** (can't see it)
- UI stops working when switching to any other visualizer
- ForceGraph, Sketch, Mermaid all break the counter UI

### ‚ö†Ô∏è Traffic Light - PARTIAL
- Works: ForceGraph, ReactFlow
- Broken: Mermaid, Sketch (light UI stops responding)

### ‚ùå Rock Paper Scissors - MOSTLY BROKEN
- Works: ReactFlow only
- Stuck/broken: Sketch and all others

### ‚ö†Ô∏è Stopwatches - PARTIAL
- Work on default (ForceGraph)
- **Switching away then back breaks them**

### üî¥ P0 BUG: Visualizer Switch Breaks UI

**Pattern:** Changing visualizer type breaks the example's UI functionality.
- Hypothesis: Something in visualizer components is mutating machine state or interfering with hooks
- Toggle works (reference) - others don't
- Need to diff Toggle vs Counter to find difference

### üü† P1 BUG: ReactFlow Height Missing

**Issue:** ReactFlow renders but has no height in some examples (e.g., Counter)
- May have lost CSS/container styling from deleted components
- Need to port height handling from old HSMVisualizerDemo

---

## New QA Feedback (2025-12-30 2:29pm)

### üü° Dark Theme Edge Label Color Issue
- **Location:** ReactFlow edge labels (inactive state)
- **Issue:** Text color too dark on dark theme backgrounds
- **Fix needed:** Make lighter than active labels but still readable on dark backgrounds

### üî¥ Redundant Action Buttons UI Regression
- **Location:** Rock Paper Scissors, HSM Traffic Light, HSM ComboBox examples
- **Issue:** Extra UI component at bottom showing "available actions" 
- **Problem:** Redundant, not as good as game UI, shows laundry list of transitions (most don't work)
- **Impact:** More harm than help, confusing UX

### üü° Mermaid Statechart Scrollable (Mixed)
- **Location:** Stopwatch example
- **Issue:** Mermaid state chart is scrollable (better than overflow)
- **Note:** Acceptable tradeoff, better than overflowing

### üî¥ Promise Fetcher Click Error
- **Location:** Promise Fetcher example
- **Issue:** Clicking "executing" label throws error
- **Error:** "Cannot read properties of undefined reading zero at object.pending"
- **Expected:** Should fail gracefully or not allow invalid clicks
